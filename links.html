<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkLaunch | Your Personal Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f0f3f9;
            --card-bg: #e9ecf4;
            --text-color: #556070;
            --subtle-text: #6b778d;
            --border-color: #d1d9e6;
            --shadow-light: #ffffff;
            --shadow-dark: #b1c1d8;
            
            --primary-color: #4A90E2;
            --primary-light: #e9f2fc;
            --accent-color: #50E3C2;
            --star-color: #FFD23F;
            --success-color: #7ED321;
            --danger-color: #FF6B6B;
            --info-color: #4A90E2;
        }

        body.dark-mode {
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-color: #edf2f7;
            --subtle-text: #a0aec0;
            --border-color: #4a5568;
            --shadow-light: #444c5d;
            --shadow-dark: #12161f;
            
            --primary-color: #63b3ed;
            --primary-light: #2c5282;
            --success-color: #9cd659;
            --danger-color: #ff8b8b;
            --info-color: #63b3ed;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
        }

        .app-container {
            max-width: 1200px;
            margin: 15px auto 0;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 15px;
            flex-wrap: wrap;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: 
                -1px -1px 2px var(--shadow-light),
                1px 1px 2px var(--shadow-dark);
        }
        body.dark-mode header h1 {
            color: var(--text-color);
            text-shadow: 
                -1px -1px 2px var(--shadow-light),
                1px 1px 2px var(--shadow-dark);
        }
        
        .view-switcher {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            display: flex;
            padding: 3px;
        }
        .view-switcher button {
            padding: 8px 16px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            background-color: transparent;
            color: var(--subtle-text);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .view-switcher button.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        .header-actions { display: flex; align-items: center; gap: 10px; }

        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 300px;
        }
        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--subtle-text);
        }
        #search-input {
            width: 100%;
            padding: 10px 15px 10px 35px;
            border-radius: 10px;
            border: none;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        #search-input:focus {
            outline: none;
            box-shadow: inset 0 0 0 2px var(--primary-color), inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        
        .neumorphic-icon-btn {
            background-color: var(--card-bg);
            border: none;
            color: var(--subtle-text);
            font-size: 1.1rem;
            cursor: pointer; 
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }
        .neumorphic-icon-btn:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
        }
        .neumorphic-icon-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px) scale(0.98);
        }
        
        #add-btn {
            padding: 10px 20px;
            border-radius: 10px; border: none; background-color: var(--primary-color);
            color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            font-size: 1rem;
        }
        #add-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        #add-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); transform: translateY(2px); }


        /* --- Main Content Containers --- */
        #groups-container, #templates-container {
            column-count: auto;
            column-width: 320px;
            column-gap: 25px;
            margin-top: 15px;
        }
        
        .link-group, .template-group {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            transition: box-shadow 0.3s;
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            break-inside: avoid;
        }
        
        .link-group.drag-over { border: 2px dashed var(--primary-color); }
        
        .group-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 10px; 
            margin-bottom: 20px;
            flex-shrink: 0;
            cursor: grab;
        }
        .group-header h2 { 
            font-size: 1.25rem;
            color: var(--text-color); 
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .group-header .button-group {
            display: flex;
            gap: 10px;
        }

        .neumorphic-small-btn {
            background-color: var(--card-bg);
            border: none;
            color: var(--subtle-text);
            font-size: 0.9rem;
            cursor: pointer; 
            width: 28px;
            height: 28px;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
        }
        .neumorphic-small-btn:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }
        .neumorphic-small-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px) scale(0.98);
        }
        
        .cards-container { 
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* --- Link Specific --- */
        .link-card {
            display: flex; 
            align-items: center;
            padding: 10px 15px;
            border-radius: 10px; 
            text-decoration: none;
            color: var(--text-color); 
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; 
            cursor: pointer;
            background-color: var(--bg-color);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .link-card:hover { transform: translateY(-2px); box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); }
        .link-card.dragging { opacity: 0.5; }
        .link-card img { 
            width: 24px; 
            height: 24px; 
            margin-right: 12px; 
            border-radius: 4px; 
        }
        .link-card span { 
            flex-grow: 1; 
            font-weight: 500; 
            font-size: 1rem; 
        }
        .link-card-actions { display: flex; opacity: 0; transition: opacity 0.2s; }
        .link-card:hover .link-card-actions { opacity: 1; }
        .link-card-actions button {
            background: none; border: none; color: var(--subtle-text);
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
        }
        .link-card-actions button:hover { background-color: var(--border-color); color: var(--primary-color);}

        /* --- Template Specific (Updated for better UI/UX) --- */
        .template-card {
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            padding: 15px; 
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .template-card:hover { transform: translateY(-2px); box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); }
        
        .template-card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px;
            margin-bottom: 8px;
        }
        .template-card-header h3 { 
            font-size: 1.1rem; 
            font-weight: 600;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .template-card-header .template-card-actions {
            display: flex;
            gap: 5px;
        }
        .template-card-actions button {
            background: none; 
            border: none; 
            color: var(--subtle-text); 
            font-size: 1rem;
            cursor: pointer; 
            width: 28px;
            height: 28px;
            border-radius: 50%;
            transition: color 0.2s, background-color 0.2s;
        }
        .template-card-actions button:hover { color: var(--primary-color); background-color: var(--border-color); }

        .template-body-preview {
            background-color: var(--card-bg);
            padding: 12px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--subtle-text);
            box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
            
            /* Key changes for compact, modern, and scrollable look */
            max-height: 120px; /* Adjust this value to control the height */
            overflow-y: auto; /* Enables vertical scrolling when content exceeds max-height */
            white-space: pre-wrap;
        }

        .template-body-preview::-webkit-scrollbar {
            width: 6px;
        }
        .template-body-preview::-webkit-scrollbar-thumb {
            background-color: var(--subtle-text);
            border-radius: 3px;
        }

        /* Ensure the inner Quill editor div conforms to the parent's layout */
        .template-body-preview .ql-editor {
            padding: 0 !important; 
            min-height: auto !important;
            max-height: 100% !important;
            white-space: pre-wrap !important;
            overflow: visible !important;
        }
        
        /* Quill editor specific styles for Neumorphic theme */
        .ql-toolbar {
            border: none !important;
            background-color: var(--bg-color) !important;
            border-radius: 8px 8px 0 0;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            margin-top: 15px;
            padding: 8px !important;
        }
        .ql-container {
            border: none !important;
            background-color: var(--bg-color) !important;
            border-radius: 0 0 8px 8px;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            color: var(--text-color);
            font-size: 1rem;
            min-height: 150px;
            padding: 12px !important;
        }
        .ql-container.ql-snow {
             border-top: 1px solid var(--border-color) !important;
        }
        .ql-toolbar.ql-snow .ql-stroke, .ql-toolbar.ql-snow .ql-fill {
            stroke: var(--subtle-text);
        }
        .ql-toolbar.ql-snow .ql-active .ql-stroke, .ql-toolbar.ql.snow .ql-active .ql-fill {
            stroke: var(--primary-color);
            fill: var(--primary-color);
        }
        .ql-toolbar.ql-snow .ql-picker-label, .ql-toolbar.ql.snow .ql-picker-item {
            color: var(--subtle-text);
        }
        body.dark-mode .ql-toolbar.ql-snow .ql-stroke, body.dark-mode .ql-toolbar.ql.snow .ql-fill {
            stroke: var(--subtle-text);
        }
        body.dark-mode .ql-toolbar.ql.snow .ql-active .ql-stroke, body.dark-mode .ql-toolbar.ql.snow .ql-active .ql-fill {
            stroke: var(--primary-color);
            fill: var(--primary-color);
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background-color: var(--card-bg); 
            padding: 25px; 
            border-radius: 16px;
            width: 90%; 
            max-width: 500px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            /* NEW: Add vertical centering and scroll overflow */
            max-height: 90vh; 
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 1.5rem; }
        .modal-close-btn { font-size: 1.5rem; background: none; border: none; color: var(--subtle-text); cursor: pointer; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: none;
            border-radius: 8px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        #new-group-input, #new-template-group-input { margin-top: 10px; }
        #template-body { min-height: 150px; resize: vertical; font-family: monospace;}
        .modal-actions { margin-top: 25px; text-align: right; }
        
        .modal-actions .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            color: white;
            background-color: var(--primary-color);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            transition: all 0.3s;
        }
        .modal-actions .action-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8-8px 16px var(--shadow-light);
        }
        .modal-actions .action-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px) scale(0.98);
        }

        /* --- NEW STYLES FOR CONFIRMATION MODAL BUTTONS --- */
        .modal-actions .action-btn.secondary {
            background-image: none;
            background-color: var(--border-color);
            color: var(--subtle-text);
            box-shadow: none;
        }
        .modal-actions .action-btn.secondary:hover {
            background-color: #d1d9e6;
            transform: none;
            box-shadow: none;
        }
        body.dark-mode .modal-actions .action-btn.secondary {
            background-color: #4a5568;
            color: var(--text-color);
        }
        body.dark-mode .modal-actions .action-btn.secondary:hover {
            background-color: #525f73;
        }
        .modal-actions .action-btn.danger {
            background-image: none;
            background-color: var(--danger-color);
        }
        .modal-actions .action-btn.danger:hover {
            background-color: #e43d42;
        }


        .group-choice-container {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .group-choice-container .group-choice-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            transition: all 0.2s ease;
            background-color: var(--bg-color);
            color: var(--subtle-text);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .group-choice-container .group-choice-label:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }

        .group-choice-container input[type="radio"] {
            display: none;
        }
        
        .radio-custom {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--card-bg);
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .radio-custom::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: transparent;
            transition: background-color 0.2s ease;
        }
        
        input[type="radio"]:checked + .group-choice-label {
            background-color: var(--primary-light);
            color: var(--primary-color);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }

        input[type="radio"]:checked + .group-choice-label .radio-custom {
            background-color: var(--primary-color);
            box-shadow: 2px 2px 4px var(--shadow-dark), -2px -2px 4px var(--shadow-light);
        }
        
        input[type="radio"]:checked + .group-choice-label .radio-custom::after {
            background-color: var(--primary-light);
        }
        
        .hidden { display: none !important; }

        /* Styles for the non-blocking message box */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-dark);
            font-weight: 600;
            z-index: 2000;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
        }
        .message-box.show {
            transform: translateX(0);
        }
        .message-box.success { background-color: var(--success-color); }
        .message-box.error { background-color: var(--danger-color); }
        .message-box.info { background-color: var(--info-color); }

        /* SortableJS drag and drop styling */
        .link-card.sortable-chosen, .link-group.sortable-chosen {
            opacity: 0.5;
            background-color: var(--primary-light);
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .link-group.sortable-drag, .link-group.sortable-ghost {
            opacity: 0;
        }
        .link-card.sortable-ghost, .link-group.sortable-ghost {
            opacity: 0;
        }
        .link-card.sortable-drag {
            box-shadow: 10px 10px 20px var(--shadow-dark), -10px -10px 20px var(--shadow-light);
            transform: scale(1.05);
        }
        
        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            .search-box {
                max-width: 100%;
                flex-grow: 1;
            }
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-left">
                <h1>LinkLaunch</h1>
                <div class="view-switcher">
                    <button id="show-links-btn" class="active">Links</button>
                    <button id="show-templates-btn">Templates</button>
                </div>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search...">
                </div>
                <button id="add-btn"><i class="fa-solid fa-plus"></i> Add Link</button>
                <button id="save-backup-btn" class="neumorphic-icon-btn" title="Save Backup to File"><i class="fa-solid fa-download"></i></button>
                <label for="load-backup-input" id="load-backup-label" class="neumorphic-icon-btn" title="Load Backup from File"><i class="fa-solid fa-upload"></i></label>
                <input type="file" id="load-backup-input" class="hidden" accept=".json">
                <button id="theme-toggle" class="neumorphic-icon-btn" aria-label="Toggle dark mode">
                    <i class="fa-solid fa-moon"></i>
                </button>
            </div>
        </header>

        <main>
            <div id="groups-container"></div>
            <div id="templates-container" class="hidden"></div>
        </main>
    </div>

    <div id="add-link-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="link-modal-title">Add New Link</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <form id="link-form">
                <input type="hidden" id="link-id">
                <div class="form-group">
                    <label for="link-url">URL</label>
                    <input type="url" id="link-url" placeholder="https://example.com" required>
                </div>
                <div class="form-group">
                    <label for="link-title">Title</label>
                    <input type="text" id="link-title" placeholder="e.g., Google Drive" required>
                </div>
                <div class="form-group">
                    <label>Group Action</label>
                    <div class="group-choice-container">
                        <input type="radio" id="link-group-existing" name="link-group-choice" value="existing" checked>
                        <label for="link-group-existing" class="group-choice-label">
                            Add to Existing Group
                        </label>
                        <input type="radio" id="link-group-new" name="link-group-choice" value="new">
                        <label for="link-group-new" class="group-choice-label">
                            Create New Group
                        </label>
                    </div>
                </div>
                <div class="form-group" id="existing-link-group-container">
                    <label for="link-group-select">Select Group</label>
                    <select id="link-group-select"></select>
                </div>
                <div class="form-group hidden" id="new-link-group-container">
                    <label for="new-group-input">New Group Name</label>
                    <input type="text" id="new-group-input" placeholder="New group name...">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="action-btn"><i class="fa-solid fa-floppy-disk"></i> Save Link</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="template-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="template-modal-title">Add New Template</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <form id="template-form">
                <input type="hidden" id="template-id">
                <div class="form-group">
                    <label for="template-title">Template Title</label>
                    <input type="text" id="template-title" placeholder="e.g., Weekly Report Email" required>
                </div>

                <div class="form-group">
                    <label>Group Action</label>
                    <div class="group-choice-container">
                        <input type="radio" id="template-group-existing" name="template-group-choice" value="existing" checked>
                        <label for="template-group-existing" class="group-choice-label">
                            Add to Existing Group
                        </label>
                        <input type="radio" id="template-group-new" name="template-group-choice" value="new">
                        <label for="template-group-new" class="group-choice-label">
                            Create New Group
                        </label>
                    </div>
                </div>
                <div class="form-group" id="existing-template-group-container">
                    <label for="template-group-select">Select Group</label>
                    <select id="template-group-select"></select>
                </div>
                <div class="form-group hidden" id="new-template-group-container">
                    <label for="new-template-group-input">New Group Name</label>
                    <input type="text" id="new-template-group-input" placeholder="Enter new group name...">
                </div>
                <div class="form-group">
                    <label for="template-editor">Template Body</label>
                    <small style="color: var(--subtle-text); display: block; margin-top: -5px; margin-bottom: 8px;">Use placeholders like {{name}} or {{date}}</small>
                    <div id="template-editor" style="min-height: 150px;"></div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="action-btn"><i class="fa-solid fa-floppy-disk"></i> Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <div id="placeholder-modal" class="modal-overlay">
        <div class="modal">
             <div class="modal-header">
                <h2>Fill in Placeholders</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <form id="placeholder-form">
                <div id="placeholder-fields"></div>
                <div class="modal-actions">
                    <button type="submit" class="action-btn"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate & Copy</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal">
             <div class="modal-header">
                <h2 id="confirm-modal-title">Confirm Action</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <p id="confirm-modal-text" style="margin: 20px 0; font-size: 1.1rem; color: var(--subtle-text);">Are you sure?</p>
            <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="confirm-cancel-btn" class="action-btn secondary">Cancel</button>
                <button id="confirm-delete-btn" class="action-btn danger">Delete</button>
            </div>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // --- DASHBOARD COMMUNICATION SCRIPT ---
        const linkDataKey = 'linkLaunchData';
        const templateDataKey = 'linkLaunchTemplateGroups';

        window.addEventListener('message', (event) => {
            const { action, keys, values, theme } = event.data; // Added 'keys' and 'values'

            if (action === 'getDataForBackup') {
                const linkData = localStorage.getItem(linkDataKey) || '[]';
                const templateData = localStorage.getItem(templateDataKey) || '[]';
                window.parent.postMessage({
                    action: 'backupDataResponse',
                    key: [linkDataKey, templateDataKey],
                    value: [linkData, templateData]
                }, '*');
            }
            
            // ðŸš¨ CRITICAL FIX for Dashboard Restore ðŸš¨
            if (action === 'restoreData') {
                if (keys && values && Array.isArray(keys) && keys.length === values.length) {
                    const linkIndex = keys.indexOf(linkDataKey);
                    const templateIndex = keys.indexOf(templateDataKey);
                    let restored = false;

                    try {
                        // 1. Restore Links Data
                        if (linkIndex !== -1 && values[linkIndex] !== undefined) {
                            localStorage.setItem(linkDataKey, values[linkIndex]);
                            restored = true;
                        }
                        // 2. Restore Templates Data
                        if (templateIndex !== -1 && values[templateIndex] !== undefined) {
                            localStorage.setItem(templateDataKey, values[templateIndex]);
                            restored = true;
                        }

                        if (restored) {
                            // Signal completion before reload
                            window.parent.postMessage({ action: 'restoreComplete', file: 'links.html' }, '*');
                            // Force a reload to pick up the new data from localStorage
                            setTimeout(() => location.reload(), 500); 
                            showMessage("LinkLaunch data restored. Reloading...", "success");
                        } else {
                            window.parent.postMessage({ action: 'restoreComplete', file: 'links.html' }, '*');
                        }
                    } catch (e) {
                        console.error("Error restoring data in links.html:", e);
                        showMessage("Restore failed: Invalid data format.", "error");
                        window.parent.postMessage({ action: 'restoreComplete', file: 'links.html' }, '*');
                    }
                } else {
                    // Mismatched keys/values, signal completion anyway
                    window.parent.postMessage({ action: 'restoreComplete', file: 'links.html' }, '*');
                }
            }
            
            if (action === 'setTheme') {
                document.body.classList.toggle('dark-mode', theme === 'dark');
                const themeToggleBtn = document.getElementById('theme-toggle');
                if (themeToggleBtn) {
                     themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
                }
            }
        });
        // --- END COMMUNICATION SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT SELECTORS ---
            const groupsContainer = document.getElementById('groups-container');
            const templatesContainer = document.getElementById('templates-container');
            const addBtn = document.getElementById('add-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const searchInput = document.getElementById('search-input');
            const showLinksBtn = document.getElementById('show-links-btn');
            const showTemplatesBtn = document.getElementById('show-templates-btn');
            
            const linkForm = document.getElementById('link-form');
            const linkModalTitle = document.getElementById('link-modal-title');
            const linkIdInput = document.getElementById('link-id');
            const linkUrlInput = document.getElementById('link-url');
            const linkTitleInput = document.getElementById('link-title');
            const linkGroupSelect = document.getElementById('link-group-select');
            const newGroupInput = document.getElementById('new-group-input');
            const linkGroupChoiceRadios = document.querySelectorAll('input[name="link-group-choice"]');
            const existingLinkGroupContainer = document.getElementById('existing-link-group-container');
            const newLinkGroupContainer = document.getElementById('new-link-group-container');

            const templateForm = document.getElementById('template-form');
            const templateModalTitle = document.getElementById('template-modal-title');
            const templateIdInput = document.getElementById('template-id');
            const templateTitleInput = document.getElementById('template-title');
            // const templateBodyInput = document.getElementById('template-body');
            const templateGroupSelect = document.getElementById('template-group-select');
            const newTemplateGroupInput = document.getElementById('new-template-group-input');
            
            const templateGroupChoiceRadios = document.querySelectorAll('input[name="template-group-choice"]');
            const existingTemplateGroupContainer = document.getElementById('existing-template-group-container');
            const newTemplateGroupContainer = document.getElementById('new-template-group-container');

            const placeholderModal = document.getElementById('placeholder-modal');
            const placeholderForm = document.getElementById('placeholder-form');
            const placeholderFields = document.getElementById('placeholder-fields');
            let currentTemplateBody = '';

            const saveBackupBtn = document.getElementById('save-backup-btn');
            const loadBackupInput = document.getElementById('load-backup-input');
            const messageBox = document.getElementById('messageBox');
            
            // NEW: Quill Editor Initialization
            const quill = new Quill('#template-editor', {
                theme: 'snow',
                placeholder: 'Type your template content here...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline', 'link'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });


            // --- APP STATE ---
            let linkGroups = JSON.parse(localStorage.getItem(linkDataKey)) || [];
            let templateGroups = JSON.parse(localStorage.getItem(templateDataKey)) || [];
            let currentView = 'links';
            let dataIsDirty = false;

            // --- DATA PERSISTENCE ---
            const saveAllData = () => {
                localStorage.setItem(linkDataKey, JSON.stringify(linkGroups));
                localStorage.setItem(templateDataKey, JSON.stringify(templateGroups));
                dataIsDirty = true;
            };
            const saveLinkData = () => {
                localStorage.setItem(linkDataKey, JSON.stringify(linkGroups));
                dataIsDirty = true;
		window.parent.postMessage({ action: 'dataUpdated' }, '*');
            }
            const saveTemplateData = () => {
                localStorage.setItem(templateDataKey, JSON.stringify(templateGroups));
                dataIsDirty = true;
		window.parent.postMessage({ action: 'dataUpdated' }, '*');
            }

            // --- RENDER HELPERS ---
            const updateGroupOptions = (selectElement, groups, includeNewOption = true) => {
                const currentVal = selectElement.value;
                selectElement.innerHTML = '';
                selectElement.disabled = false;

                if (groups.length === 0) {
                    const noGroupsOption = document.createElement('option');
                    noGroupsOption.value = '';
                    noGroupsOption.textContent = 'No groups exist yet';
                    selectElement.appendChild(noGroupsOption);
                    if (!includeNewOption) {
                        selectElement.disabled = true;
                    }
                    return;
                }

                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    selectElement.appendChild(option);
                });
                
                if (includeNewOption) {
                    const newGroupOption = document.createElement('option');
                    newGroupOption.value = '--new-group--';
                    newGroupOption.textContent = 'Create new group...';
                    selectElement.appendChild(newGroupOption);
                }
                
                if (groups.find(g => g.id == currentVal)) {
                    selectElement.value = currentVal;
                }
            };

            // --- CORE RENDER FUNCTIONS ---
            const render = () => {
                if (currentView === 'links') renderGroups();
                else renderTemplates();
            };
            
            const renderGroups = () => {
                groupsContainer.innerHTML = '';
                linkGroups.forEach(group => {
                    const groupEl = document.createElement('div');
                    groupEl.className = 'link-group';
                    groupEl.dataset.groupId = group.id;
                    
                    const linksHtml = (group.links || []).map(link => `
                        <a href="${link.url}" target="_blank" class="link-card" data-link-id="${link.id}" draggable="true">
                            <img src="https://www.google.com/s2/favicons?domain=${new URL(link.url).hostname}&sz=32" onerror="this.onerror=null;this.src='https://placehold.co/24x24/b1c1d8/556070?text=L';" alt="">
                            <span>${link.title}</span>
                            <div class="link-card-actions">
                                <button data-action="edit-link" title="Edit" class="neumorphic-small-btn"><i class="fa-solid fa-pencil"></i></button>
                                <button data-action="delete-link" title="Delete" class="neumorphic-small-btn"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </a>`).join('');

                    groupEl.innerHTML = `
                        <div class="group-header" draggable="true">
                            <h2>${group.name}</h2>
                            <div class="group-actions">
                                <div class="button-group">
                                    <button data-action="edit-group" title="Edit Group Name" class="neumorphic-small-btn"><i class="fa-solid fa-pencil"></i></button>
                                    <button data-action="delete-group" title="Delete Group" class="neumorphic-small-btn"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="cards-container">${linksHtml}</div>`;
                    groupsContainer.appendChild(groupEl);
                });
                updateGroupOptions(linkGroupSelect, linkGroups, false);
                addDragAndDropListeners();
            };

            const renderTemplates = () => {
                templatesContainer.innerHTML = '';
                templateGroups.forEach(group => {
                    const groupEl = document.createElement('div');
                    groupEl.className = 'template-group';
                    groupEl.dataset.groupId = group.id;

                    const templatesHtml = (group.templates || []).map(template => `
                        <div class="template-card" data-template-id="${template.id}">
                            <div class="template-card-header">
                                <h3>${template.title}</h3>
                                <div class="template-card-actions">
                                    <button data-action="edit-template" title="Edit" class="neumorphic-small-btn"><i class="fa-solid fa-pencil"></i></button>
                                    <button data-action="delete-template" title="Delete" class="neumorphic-small-btn"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                            <div class="template-body-preview">
                                <div class="ql-container ql-snow" style="border: none !important; box-shadow: none !important; padding: 0 !important; font-size: 0.85rem;">
                                    <div class="ql-editor" style="padding: 0; min-height: auto; white-space: pre-wrap; overflow: hidden; max-height: 100px;">
                                        ${template.body}
                                    </div>
                                </div>
                            </div>
                        </div>`).join('');

                    groupEl.innerHTML = `
                           <div class="group-header">
                                <h2>${group.name}</h2>
                                <div class="group-actions">
                                    <div class="button-group">
                                        <button data-action="edit-template-group" title="Edit Group Name" class="neumorphic-small-btn"><i class="fa-solid fa-pencil"></i></button>
                                        <button data-action="delete-template-group" title="Delete Group" class="neumorphic-small-btn"><i class="fa-solid fa-trash-can"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="cards-container">${templatesHtml}</div>`;
                    templatesContainer.appendChild(groupEl);
                });
                updateGroupOptions(templateGroupSelect, templateGroups, false);
            };

            // --- VIEW SWITCHING ---
            const switchView = (view) => {
                currentView = view;
                showLinksBtn.classList.toggle('active', view === 'links');
                showTemplatesBtn.classList.toggle('active', view === 'templates');
                groupsContainer.classList.toggle('hidden', view !== 'links');
                templatesContainer.classList.toggle('hidden', view !== 'templates');
                addBtn.innerHTML = view === 'links' ? '<i class="fa-solid fa-plus"></i> Add Link' : '<i class="fa-solid fa-plus"></i> Add Template';
                searchInput.placeholder = view === 'links' ? 'Search links...' : 'Search templates...';
                searchInput.value = '';
                render();
            };
            showLinksBtn.addEventListener('click', () => switchView('links'));
            showTemplatesBtn.addEventListener('click', () => switchView('templates'));

            // --- CUSTOM CONFIRM MODAL ---
            function showConfirmModal(message) {
                return new Promise((resolve, reject) => {
                    const confirmModal = document.getElementById('confirm-modal');
                    const confirmText = document.getElementById('confirm-modal-text');
                    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
                    const closeModalBtn = confirmModal.querySelector('.modal-close-btn');

                    confirmText.textContent = message;
                    confirmModal.classList.add('active');

                    const cleanup = () => {
                        confirmModal.classList.remove('active');
                        confirmDeleteBtn.removeEventListener('click', onConfirm);
                        confirmCancelBtn.removeEventListener('click', onCancel);
                        closeModalBtn.removeEventListener('click', onCancel);
                    };

                    const onConfirm = () => {
                        cleanup();
                        resolve(true);
                    };

                    const onCancel = () => {
                        cleanup();
                        reject(false);
                    };
                    
                    confirmDeleteBtn.addEventListener('click', onConfirm, { once: true });
                    confirmCancelBtn.addEventListener('click', onCancel, { once: true });
                    closeModalBtn.addEventListener('click', onCancel, { once: true });
                });
            }

            // --- MODAL HANDLING ---
            const openModal = (type, data = null) => {
                const linkModal = document.getElementById('add-link-modal');
                const templateModal = document.getElementById('template-modal');
                if (type === 'link') {
                    linkForm.reset();
                    document.getElementById('link-group-existing').checked = true;
                    existingLinkGroupContainer.classList.remove('hidden');
                    newLinkGroupContainer.classList.add('hidden');
                    linkModalTitle.textContent = data ? 'Edit Link' : 'Add New Link';
                    if (data) {
                        linkIdInput.value = data.link.id;
                        linkUrlInput.value = data.link.url;
                        linkTitleInput.value = data.link.title;
                        linkGroupSelect.value = data.groupId;
                    } else {
                        linkIdInput.value = '';
                    }
                    linkModal.classList.add('active');
                } else if (type === 'template') {
                    templateForm.reset();
                    templateModalTitle.textContent = data ? 'Edit Template' : 'Add New Template';
                    document.getElementById('template-group-existing').checked = true;
                    existingTemplateGroupContainer.classList.remove('hidden');
                    newTemplateGroupContainer.classList.add('hidden');
                    if (data) {
                        templateIdInput.value = data.template.id;
                        templateTitleInput.value = data.template.title;
                        quill.root.innerHTML = data.template.body;
                        templateGroupSelect.value = data.groupId;
                    } else {
                        linkIdInput.value = '';
                        quill.root.innerHTML = '';
                    }
                    templateModal.classList.add('active');
                }
            };

            const closeModal = () => {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            };

            addBtn.addEventListener('click', () => openModal(currentView === 'links' ? 'link' : 'template'));
            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
            });

            // --- FORM & DROPDOWN LISTENERS ---
            linkGroupChoiceRadios.forEach(radio => {
                radio.addEventListener('change', e => {
                    const isNew = e.target.value === 'new';
                    existingLinkGroupContainer.classList.toggle('hidden', isNew);
                    newLinkGroupContainer.classList.toggle('hidden', !isNew);
                });
            });
            
            templateGroupChoiceRadios.forEach(radio => {
                radio.addEventListener('change', e => {
                    const isNew = e.target.value === 'new';
                    existingTemplateGroupContainer.classList.toggle('hidden', isNew);
                    newTemplateGroupContainer.classList.toggle('hidden', !isNew);
                });
            });

            linkForm.addEventListener('submit', handleLinkFormSubmit);
            templateForm.addEventListener('submit', handleTemplateFormSubmit);

            // --- FORM SUBMISSION LOGIC ---
            function handleLinkFormSubmit(e) {
                e.preventDefault();
                const url = linkUrlInput.value.trim();
                const title = linkTitleInput.value.trim();
                const linkId = Number(linkIdInput.value);
                let targetGroupId;
                
                const choice = document.querySelector('input[name="link-group-choice"]:checked').value;

                if (choice === 'new') {
                    const newGroupName = newGroupInput.value.trim();
                    if (!newGroupName) return showMessage("Please enter a name for the new group.", "error");
                    const newGroup = { id: Date.now(), name: newGroupName, links: [] };
                    linkGroups.push(newGroup);
                    targetGroupId = newGroup.id;
                } else { // 'existing'
                    const selectedGroupId = linkGroupSelect.value;
                    if (!selectedGroupId) {
                        return showMessage("Please select a group or create a new one.", "error");
                    }
                    targetGroupId = Number(selectedGroupId);
                }

                const newLink = { id: linkId || Date.now(), url, title };
                if (linkId) {
                    let oldGroup = linkGroups.find(g => g.links.some(l => l.id === linkId));
                    if (oldGroup) oldGroup.links = oldGroup.links.filter(l => l.id !== linkId);
                }
                const targetGroup = linkGroups.find(g => g.id === targetGroupId);
                if (targetGroup) {
                    if (!targetGroup.links) targetGroup.links = [];
                    targetGroup.links.push(newLink);
                }
                saveLinkData(); render(); closeModal();
            }
            
            function handleTemplateFormSubmit(e) {
                e.preventDefault();
                const title = templateTitleInput.value.trim();
                const body = quill.root.innerHTML;
                const templateId = Number(templateIdInput.value);
                let targetGroupId;

                const choice = document.querySelector('input[name="template-group-choice"]:checked').value;
                
                if (choice === 'new') {
                    const newGroupName = newTemplateGroupInput.value.trim();
                    if (!newGroupName) return showMessage("Please enter a name for the new group.", "error");
                    const newGroup = { id: Date.now(), name: newGroupName, templates: [] };
                    templateGroups.push(newGroup);
                    targetGroupId = newGroup.id;
                } else { // 'existing'
                    const selectedGroupId = templateGroupSelect.value;
                    if (!selectedGroupId) {
                        return showMessage("Please select a group or create a new one.", "error");
                    }
                    targetGroupId = Number(selectedGroupId);
                }

                const newTemplate = { id: templateId || Date.now(), title, body };
                if (templateId) {
                    let oldGroup = templateGroups.find(g => g.templates && g.templates.some(t => t.id === templateId));
                    if (oldGroup) oldGroup.templates = oldGroup.templates.filter(t => t.id !== templateId);
                }
                const targetGroup = templateGroups.find(g => g.id === targetGroupId);
                if(targetGroup) {
                    if (!targetGroup.templates) targetGroup.templates = [];
                    targetGroup.templates.push(newTemplate);
                }
                saveTemplateData(); render(); closeModal();
            }

            // --- MAIN EVENT DELEGATION FOR ACTIONS ---
            document.body.addEventListener('click', async (e) => {
                const templateCard = e.target.closest('.template-card');
                const button = e.target.closest('button[data-action]');
                
                // Handle clicks on template cards but not on their action buttons
                if (templateCard && !button) {
                    const templateId = Number(templateCard.dataset.templateId);
                    const groupEl = templateCard.closest('.template-group');
                    const groupId = Number(groupEl.dataset.groupId);
                    const group = templateGroups.find(g => g.id === groupId);
                    const template = group.templates.find(t => t.id === templateId);

                    handleTemplateCopy(template);
                    return; // Prevent further bubbling
                }
                
                if (!button) return;
                const action = button.dataset.action;

                const linkCard = button.closest('.link-card');
                if (linkCard) {
                    e.preventDefault();
                    const linkId = Number(linkCard.dataset.linkId);
                    const groupEl = linkCard.closest('.link-group');
                    const groupId = Number(groupEl.dataset.groupId);
                    const group = linkGroups.find(g => g.id === groupId);
                    if (!group) return;
                    const link = group.links.find(l => l.id === linkId);
                    if (!link) return;
                    if (action === 'edit-link') openModal('link', { link, groupId });
                    if (action === 'delete-link') {
                        try {
                            await showConfirmModal(`Are you sure you want to delete the link "${link.title}"?`);
                            group.links = group.links.filter(l => l.id !== linkId);
                            saveLinkData(); render();
                        } catch {}
                    }
                    return;
                }

                // FIX: Correctly handle template actions
                const templateBtn = e.target.closest('button[data-action="edit-template"], button[data-action="delete-template"]');
                if (templateBtn) {
                    e.stopPropagation();
                    const card = templateBtn.closest('.template-card');
                    const templateId = Number(card.dataset.templateId);
                    const groupEl = card.closest('.template-group');
                    const groupId = Number(groupEl.dataset.groupId);
                    const group = templateGroups.find(g => g.id === groupId);
                    if (!group) return;
                    const template = group.templates.find(t => t.id === templateId);
                    if (!template) return;
                    
                    if (action === 'edit-template') {
                        openModal('template', { template, groupId });
                    }
                    if (action === 'delete-template') {
                         try {
                            await showConfirmModal(`Are you sure you want to delete the template "${template.title}"?`);
                            group.templates = group.templates.filter(t => t.id !== templateId);
                            saveTemplateData(); render();
                        } catch {}
                    }
                    return;
                }

                const groupEl = button.closest('.link-group, .template-group');
                if (groupEl) {
                    const groupId = Number(groupEl.dataset.groupId);
                    const groupName = groupEl.querySelector('h2').textContent;
                    
                    if (action === 'edit-group') {
                        const newName = prompt("Enter new name for link group:", groupName);
                        if (newName && newName.trim()) {
                            linkGroups.find(g => g.id === groupId).name = newName.trim();
                            saveLinkData(); render();
                        }
                    }
                    if (action === 'delete-group') {
                         try {
                            await showConfirmModal(`Are you sure you want to delete the link group "${groupName}" and all its links?`);
                            linkGroups = linkGroups.filter(g => g.id !== groupId);
                            saveLinkData(); render();
                        } catch {}
                    }
                    if (action === 'edit-template-group') {
                        const newName = prompt("Enter new name for template group:", groupName);
                        if (newName && newName.trim()) {
                            templateGroups.find(g => g.id === groupId).name = newName.trim();
                            saveTemplateData(); render();
                        }
                    }
                    if (action === 'delete-template-group') {
                        try {
                            await showConfirmModal(`Are you sure you want to delete the template group "${groupName}" and all its templates?`);
                            templateGroups = templateGroups.filter(g => g.id !== groupId);
                            saveTemplateData(); render();
                        } catch {}
                    }
                }
            });
            
            /**
             * Converts HTML content from the Quill editor to a clean plaintext string.
             * @param {string} html The HTML string to convert.
             * @returns {string} The formatted plaintext string.
             */
            const htmlToPlainText = (html) => {
                let text = html;

                // Step 1: Replace Quill's block tags with newlines
                text = text.replace(/<\/p>/g, '\n\n');
                text = text.replace(/<\/h[1-6]>/g, '\n\n');
                text = text.replace(/<\/li>/g, '\n');
                
                // Step 2: Strip all other remaining HTML tags
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                text = tempDiv.textContent || tempDiv.innerText || '';

                // Step 3: Clean up extra spaces and newlines
                text = text.replace(/&nbsp;/g, ' '); // Replace non-breaking spaces
                text = text.replace(/\n\n+/g, '\n\n'); // Replaces three or more newlines with two
                
                return text.trim();
            };

            // --- TEMPLATE PLACEHOLDER LOGIC ---
            function handleTemplateCopy(template) {
                const plainText = htmlToPlainText(template.body);
                const placeholders = [...plainText.matchAll(/{{(.*?)}}/g)].map(match => match[1]);
                const uniquePlaceholders = [...new Set(placeholders)];
                
                if (uniquePlaceholders.length === 0) {
                    const plainTextContent = htmlToPlainText(template.body);
                    const htmlContent = template.body;

                    try {
                        const blobHtml = new Blob([htmlContent], { type: 'text/html' });
                        const blobText = new Blob([plainTextContent], { type: 'text/plain' });
                        const clipboardItem = new ClipboardItem({
                            'text/html': blobHtml,
                            'text/plain': blobText
                        });
                        navigator.clipboard.write([clipboardItem]);
                        showMessage('Template copied!', 'success');
                    } catch (err) {
                        console.error('Failed to copy to clipboard:', err);
                        navigator.clipboard.writeText(plainTextContent);
                        showMessage('Template copied as plain text fallback.', 'info');
                    }
                    return;
                }

                currentTemplateBody = template.body;
                placeholderFields.innerHTML = uniquePlaceholders.map(p => `
                    <div class="form-group">
                        <label for="placeholder-${p}">${p}</label>
                        <input type="text" id="placeholder-${p}" data-placeholder="${p}" required>
                    </div>`).join('');
                placeholderModal.classList.add('active');
            }

            placeholderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                let filledTemplateHtml = currentTemplateBody;
                placeholderFields.querySelectorAll('input').forEach(input => {
                    const placeholder = input.dataset.placeholder;
                    const value = input.value;
                    const placeholderRegex = new RegExp(`{{\\s*${placeholder}\\s*}}`, 'g');
                    filledTemplateHtml = filledTemplateHtml.replace(placeholderRegex, value);
                });

                const filledPlainText = htmlToPlainText(filledTemplateHtml);
                
                try {
                    const blobHtml = new Blob([filledTemplateHtml], { type: 'text/html' });
                    const blobText = new Blob([filledPlainText], { type: 'text/plain' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': blobHtml,
                        'text/plain': blobText
                    });
                    await navigator.clipboard.write([clipboardItem]);
                    showMessage('Template copied to clipboard!', 'success');
                } catch (err) {
                    console.error('Failed to copy to clipboard:', err);
                    navigator.clipboard.writeText(filledPlainText); // Fallback to plain text copy
                    showMessage('Template copied to clipboard (plain text fallback).', 'info');
                }
                
                closeModal();
            });

            // --- THEME & SEARCH & DRAG/DROP ---
            const savedTheme = localStorage.getItem('linkLaunchTheme') || 'light';
            document.body.classList.toggle('dark-mode', savedTheme === 'dark');
            themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                themeToggle.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
                localStorage.setItem('linkLaunchTheme', isDark ? 'dark' : 'light');
            });

            searchInput.addEventListener('input', e => {
                const searchTerm = e.target.value.toLowerCase();
                if (currentView === 'links') {
                    document.querySelectorAll('.link-group').forEach(group => {
                        let hasVisibleLink = false;
                        group.querySelectorAll('.link-card').forEach(card => {
                            const isVisible = card.textContent.toLowerCase().includes(searchTerm);
                            card.style.display = isVisible ? '' : 'none';
                            if (isVisible) hasVisibleLink = true;
                        });
                        group.style.display = hasVisibleLink || group.querySelector('h2').textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                } else {
                    document.querySelectorAll('.template-group').forEach(group => {
                        let hasVisibleTemplate = false;
                        group.querySelectorAll('.template-card').forEach(card => {
                            const isVisible = card.textContent.toLowerCase().includes(searchTerm);
                            card.style.display = isVisible ? '' : 'none';
                            if (isVisible) hasVisibleTemplate = true;
                        });
                         group.style.display = hasVisibleTemplate || group.querySelector('h2').textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                }
            });

            function addDragAndDropListeners() {
                // Initialize Sortable for each link card container
                document.querySelectorAll('.cards-container').forEach(container => {
                    new Sortable(container, {
                        group: 'links',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        onEnd: function (evt) {
                            const linkId = parseInt(evt.item.dataset.linkId, 10);
                            const fromGroupId = parseInt(evt.from.closest('.link-group').dataset.groupId, 10);
                            const toGroupId = parseInt(evt.to.closest('.link-group').dataset.groupId, 10);
                            
                            const link = linkGroups.find(g => g.id === fromGroupId).links.find(l => l.id === linkId);

                            if (fromGroupId !== toGroupId) {
                                // Move link between groups
                                const fromGroup = linkGroups.find(g => g.id === fromGroupId);
                                const toGroup = linkGroups.find(g => g.id === toGroupId);
                                fromGroup.links.splice(evt.oldIndex, 1);
                                toGroup.links.splice(evt.newIndex, 0, link);
                            } else {
                                // Reorder within the same group
                                const group = linkGroups.find(g => g.id === toGroupId);
                                const [movedItem] = group.links.splice(evt.oldIndex, 1);
                                group.links.splice(evt.newIndex, 0, movedItem);
                            }
                            saveLinkData();
                        }
                    });
                });
                
                // Initialize Sortable for the groups container itself
                const groupsContainer = document.getElementById('groups-container');
                if (groupsContainer) {
                    new Sortable(groupsContainer, {
                        group: 'groups',
                        handle: '.group-header',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        onEnd: function (evt) {
                            const newOrder = Array.from(evt.to.children).map(item => parseInt(item.dataset.groupId, 10));
                            linkGroups.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
                            saveLinkData();
                        }
                    });
                }
            }
            
            // --- NEW: BACKUP, RESTORE, & NOTIFICATION FUNCTIONS ---
            function showMessage(message, type = 'info') {
                const iconClass = {
                    info: 'fa-solid fa-circle-info',
                    success: 'fa-solid fa-check-circle',
                    error: 'fa-solid fa-triangle-exclamation'
                }[type];
                messageBox.innerHTML = `<i class="${iconClass}"></i> ${message}`;
                messageBox.className = `message-box ${type}`;
                setTimeout(() => { messageBox.classList.add('show'); }, 10);
                setTimeout(() => { messageBox.classList.remove('show'); }, 3000);
            }

            function saveToFile() {
                const backupData = {
                    linkGroups: linkGroups,
                    templateGroups: templateGroups
                };
                const dataToSave = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataToSave], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'linklaunch-backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                dataIsDirty = false;
                showMessage("Dashboard backup saved!", "success");
            }

            function loadFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const loadedData = JSON.parse(content);
                        if (loadedData && Array.isArray(loadedData.linkGroups) && Array.isArray(loadedData.templateGroups)) {
                            linkGroups = loadedData.linkGroups;
                            templateGroups = loadedData.templateGroups;
                            saveAllData(); // Save to localStorage
                            render();
                            showMessage("Backup restored successfully!", "success");
                        } else {
                            throw new Error("Invalid backup file format.");
                        }
                    } catch (error) {
                        showMessage("Error restoring backup. Invalid file.", "error");
                        console.error("File loading error:", error);
                    } finally {
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            }
            
            saveBackupBtn.addEventListener('click', saveToFile);
            loadBackupInput.addEventListener('change', loadFromFile);

            window.addEventListener('beforeunload', (event) => {
                if (dataIsDirty) {
                    event.preventDefault();
                    event.returnValue = '';
                }
            });

            // --- INITIALIZATION ---
            function init() {
                // BUG FIX: Re-read from localStorage on init to ensure data is fresh
                linkGroups = JSON.parse(localStorage.getItem(linkDataKey)) || [];
                templateGroups = JSON.parse(localStorage.getItem(templateDataKey)) || [];
                switchView('links');
            }

            init();
            
            // NEW: Report to the dashboard that this page is ready
            window.parent.postMessage({ action: 'pageReady', file: 'links.html' }, '*');
        });
    </script>
</body>
</html>
