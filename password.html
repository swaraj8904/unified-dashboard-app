<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Manager | Unified Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.3/dist/dexie.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f3f9;
            --card-bg: #e9ecf4;
            --text-color: #556070;
            --subtle-text: #6b778d;
            --border-color: #d1d9e6;
            --shadow-light: #ffffff;
            --shadow-dark: #b1c1d8;
            --primary-color: #4A90E2;
            --primary-light: #e9f2fc;
            --danger-color: #FF6B6B;
            --success-color: #7ED321;
            --info-color: #4A90E2;
        }

        body.dark-mode {
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-color: #edf2f7;
            --subtle-text: #a0aec0;
            --border-color: #4a5568;
            --shadow-light: #444c5d;
            --shadow-dark: #12161f;
            --primary-color: #63b3ed;
            --primary-light: #2c5282;
            --danger-color: #ff8b8b;
            --success-color: #9cd659;
            --info-color: #63b3ed;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 15px auto 0;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .header-left { display: flex; align-items: center; gap: 10px; }
        
        header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-color);
            text-shadow: -1px -1px 2px var(--shadow-light), 1px 1px 2px var(--shadow-dark);
            cursor: default;
            user-select: none;
        }
        body.dark-mode header h1 {
            color: var(--text-color);
            text-shadow: -1px -1px 2px var(--shadow-light), 1px 1px 2px var(--shadow-dark);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 300px;
        }
        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--subtle-text);
        }
        #search-input {
            width: 100%;
            padding: 10px 15px 10px 35px;
            border-radius: 10px;
            border: none;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        #search-input:focus {
            outline: none;
            box-shadow: inset 0 0 0 2px var(--primary-color), inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        
        .neumorphic-icon-btn {
            background-color: var(--card-bg);
            border: none;
            color: var(--subtle-text);
            font-size: 1.1rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }
        .neumorphic-icon-btn:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
        }
        .neumorphic-icon-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px) scale(0.98);
        }
        
        .neumorphic-text-btn {
            background-color: var(--card-bg);
            border: none;
            color: var(--subtle-text);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }
        .neumorphic-text-btn:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
        }
        .neumorphic-text-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px) scale(0.98);
        }


        #add-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            font-size: 1rem;
        }
        #add-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        #add-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); transform: translateY(2px); }
        
        .password-grid-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }

        .password-grid-header {
            display: grid;
            grid-template-columns: 12fr 15fr 10fr 12fr 10fr 10fr 10fr 15fr 6fr;
            gap: 15px;
            padding: 0 10px;
            font-weight: 600;
            color: var(--subtle-text);
        }

        .password-entry {
            display: grid;
            grid-template-columns: 12fr 15fr 10fr 12fr 10fr 10fr 10fr 15fr 6fr;
            gap: 15px;
            align-items: center;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px 10px;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            transition: all 0.2s;
        }
        .password-entry:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
        }

        .info-field {
            font-weight: 500;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .password-field-card {
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: monospace;
            transition: all 0.2s;
        }
        .password-field-card:hover {
            box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light);
        }
        
        .password-hidden {
            -webkit-text-security: disc;
            -moz-text-security: disc;
            text-security: disc;
            color: var(--subtle-text) !important;
        }

        .actions-group {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .neumorphic-small-btn {
            background-color: var(--card-bg);
            border: none;
            color: var(--subtle-text);
            font-size: 0.9rem;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
        }
        .neumorphic-small-btn:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
        }
        .neumorphic-small-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px) scale(0.98);
        }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 1.5rem; }
        .modal-close-btn { font-size: 1.5rem; background: none; border: none; color: var(--subtle-text); cursor: pointer; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
        }
        .modal-actions { margin-top: 25px; text-align: right; }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            color: white;
            background-color: var(--primary-color);
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            transition: all 0.3s;
        }
        .action-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
        }
        .action-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            transform: translateY(2px) scale(0.98);
        }
        .hidden { display: none !important; }

        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-dark);
            font-weight: 600;
            z-index: 2000;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
        }
        .message-box.show { transform: translateX(0); }
        .message-box.success { background-color: var(--success-color); }
        .message-box.error { background-color: var(--danger-color); }
        .message-box.info { background-color: var(--info-color); }
        
        #backup-btn {
            display: flex; align-items: center; justify-content: center;
            padding: 0;
            width: 40px; height: 40px;
            border-radius: 50%;
        }
        #restore-label {
            display: flex; align-items: center; justify-content: center;
            padding: 0;
            width: 40px; height: 40px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-left">
                <h1>Password Manager</h1>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search by Site ID or Customer...">
                </div>
                <button id="add-btn" class="neumorphic-text-btn"><i class="fa-solid fa-plus"></i> Add Password</button>
                <button id="backup-btn" class="neumorphic-icon-btn" title="Save Encrypted Backup"><i class="fa-solid fa-download"></i></button>
                <label for="restore-input" id="restore-label" class="neumorphic-icon-btn" title="Load Encrypted Backup"><i class="fa-solid fa-upload"></i></label>
                <input type="file" id="restore-input" class="hidden" accept=".json">
                <button id="theme-toggle" class="neumorphic-icon-btn" aria-label="Toggle dark mode">
                    <i class="fa-solid fa-moon"></i>
                </button>
            </div>
        </header>

        <main id="main-content">
            <div class="password-grid-container">
                <div class="password-grid-header">
                    <div>Site ID</div>
                    <div>Customer Name</div>
                    <div>DBC</div>
                    <div>TDAAS_Maint</div>
                    <div>VP</div>
                    <div>VAL</div>
                    <div>MLDB</div>
                    <div>Other</div>
                    <div>Actions</div>
                </div>
                <div id="password-list">
                    </div>
            </div>
        </main>
    </div>

    <div id="password-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Add New Password</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <form id="password-form">
                <input type="hidden" id="entry-id">
                <div class="form-group">
                    <label for="site-id-input">Site ID</label>
                    <input type="text" id="site-id-input" required>
                </div>
                <div class="form-group">
                    <label for="customer-name-input">Customer Name</label>
                    <input type="text" id="customer-name-input" required>
                </div>
                
                <div id="password-fields-container">
                    </div>
                
                <div class="modal-actions">
                    <button type="submit" class="action-btn" id="save-btn"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                    <button type="button" class="action-btn" id="add-field-btn"><i class="fa-solid fa-plus"></i> Add Field</button>
                </div>
            </form>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script>
        // Static encryption key - NO ADMIN PASSWORD
        const staticEncryptionKey = 'a-super-secret-key-that-is-now-hardcoded-for-simplicity';

        const defaultPasswordFields = ['dbc', 'tdaas_maint', 'VP', 'val', 'mldb'];
        
        // --- Database Initialization ---
        const db = new Dexie('PasswordManagerDB');
        db.version(1).stores({
            entries: '++id, data'
        });
        
        // --- State and DOM element definitions (Scoped outside functions for hoisting) ---
        let passwordEntries = [];
        let passwordList, searchInput, passwordModal, passwordForm, entryIdInput, siteIdInput, customerNameInput, passwordFieldsContainer, messageBox;

        // --- Helper Functions ---
        const encryptData = (data) => {
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), staticEncryptionKey).toString();
            return encrypted;
        };

        const decryptData = (encryptedData) => {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, staticEncryptionKey);
                const decryptedString = bytes.toString(CryptoJS.enc.Utf8);
                if (!decryptedString) {
                     throw new Error("Invalid decryption key or corrupted data.");
                }
                return JSON.parse(decryptedString);
            } catch(e) {
                console.error("Decryption failed:", e);
                return null;
            }
        };
        
        const showMessage = (message, type = 'info') => {
            const iconClass = { info: 'fa-solid fa-circle-info', success: 'fa-solid fa-check-circle', error: 'fa-solid fa-triangle-exclamation' }[type];
            messageBox.innerHTML = `<i class="${iconClass}"></i> ${message}`;
            messageBox.className = `message-box ${type}`;
            setTimeout(() => { messageBox.classList.add('show'); }, 10);
            setTimeout(() => { messageBox.classList.remove('show'); }, 3000);
        };

        // RENDER FUNCTION (Hoisted and made global access)
        const renderPasswords = () => {
            passwordList.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            
            passwordEntries.forEach(entry => {
                const matchesSearch = searchTerm === '' ||
                    entry.siteId.toLowerCase().includes(searchTerm) ||
                    entry.customerName.toLowerCase().includes(searchTerm) ||
                    Object.keys(entry.passwords).some(key => key.toLowerCase().includes(searchTerm));
                    
                if (!matchesSearch) return;
                
                const entryDiv = document.createElement('div');
                entryDiv.className = 'password-entry';
                entryDiv.dataset.id = entry.id;

                // Info fields
                const siteIdField = document.createElement('div');
                siteIdField.className = 'info-field';
                siteIdField.textContent = entry.siteId;
                entryDiv.appendChild(siteIdField);

                const customerNameField = document.createElement('div');
                customerNameField.className = 'info-field';
                customerNameField.textContent = entry.customerName;
                entryDiv.appendChild(customerNameField);
                
                // Default password fields
                defaultPasswordFields.forEach(field => {
                    const passwordExists = entry.passwords[field] && entry.passwords[field].length > 0;
                    const passwordCard = document.createElement('div');
                    passwordCard.className = 'password-field-card';
                    passwordCard.title = "Click to copy";
                    passwordCard.dataset.password = entry.passwords[field] || '';
                    passwordCard.textContent = passwordExists ? '****' : '';
                    passwordCard.classList.toggle('password-hidden', passwordExists);
                    entryDiv.appendChild(passwordCard);
                });

                // Other password field
                const otherPasswords = Object.keys(entry.passwords)
                    .filter(key => !defaultPasswordFields.includes(key));
                
                const otherCard = document.createElement('div');
                otherCard.className = 'password-field-card';
                
                if (otherPasswords.length > 0) {
                    const firstOtherKey = otherPasswords[0];
                    const passwordExists = entry.passwords[firstOtherKey] && entry.passwords[firstOtherKey].length > 0;
                    otherCard.dataset.password = entry.passwords[firstOtherKey] || '';
                    otherCard.title = `Click to copy`;
                    otherCard.textContent = `EXTRA: ${passwordExists ? '****' : ''}`;
                    otherCard.classList.toggle('password-hidden', passwordExists);
                } else {
                    otherCard.textContent = 'Other';
                }
                entryDiv.appendChild(otherCard);

                // Actions buttons
                const actionsGroup = document.createElement('div');
                actionsGroup.className = 'actions-group';
                actionsGroup.innerHTML = `
                    <button class="neumorphic-small-btn unhide-btn" title="Show/Hide Passwords"><i class="fa-solid fa-eye"></i></button>
                    <button class="neumorphic-small-btn edit-btn" title="Edit"><i class="fa-solid fa-pencil"></i></button>
                    <button class="neumorphic-small-btn delete-btn" title="Delete"><i class="fa-solid fa-trash-can"></i></button>
                `;
                entryDiv.appendChild(actionsGroup);

                passwordList.appendChild(entryDiv);
            });
        };

        const loadData = async () => {
            try {
                const encryptedEntries = await db.entries.toArray();
                passwordEntries = encryptedEntries.map(entry => decryptData(entry.data)).filter(Boolean);
                if (encryptedEntries.length > 0 && passwordEntries.length === 0) {
                    console.warn("Data exists but could not be decrypted. Check staticEncryptionKey consistency.");
                }
                // CRITICAL: Call renderPasswords after loadData is done
                renderPasswords(); 
                return true;
            } catch (e) {
                console.error("Failed to load data from IndexedDB:", e);
                return false;
            }
        };

        const saveData = async (entriesToSave = passwordEntries) => {
            await db.entries.clear();
            const encryptedEntries = entriesToSave.map(entry => ({ data: encryptData(entry) }));
            await db.entries.bulkAdd(encryptedEntries);
	    window.parent.postMessage({ action: 'dataUpdated' }, '*');
        };

        
        // --- DASHBOARD COMMUNICATION SCRIPT (UNCHANGED CORE LOGIC) ---
        window.addEventListener('message', async (event) => {
            const { action, keys, values, theme } = event.data;
            
            if (action === 'setTheme') {
                document.body.classList.toggle('dark-mode', theme === 'dark');
            }
            
            if (action === 'getDataForBackup') {
                try {
                    const allEntries = await db.entries.toArray();
                    const dataStr = JSON.stringify(allEntries);
                    window.parent.postMessage({ 
                        action: 'backupDataResponse', 
                        key: 'passwordManagerData', 
                        value: dataStr 
                    }, '*');
                } catch(e) {
                    console.error("Backup failed during IndexedDB read:", e);
                    window.parent.postMessage({ action: 'backupDataResponse', key: 'passwordManagerData', value: '' }, '*');
                }
            }

            if (action === 'restoreData') {
                const dataKey = 'passwordManagerData';
                if (keys && values && Array.isArray(keys) && keys.length === values.length) {
                    const keyIndex = keys.indexOf(dataKey);
                    const encryptedDataValue = (keyIndex !== -1 && values[keyIndex] !== undefined) ? values[keyIndex] : null;
                    
                    if (encryptedDataValue) {
                        try {
                            const loadedEntries = JSON.parse(encryptedDataValue);
                            
                            if (Array.isArray(loadedEntries)) {
                                await db.entries.clear();
                                await db.entries.bulkAdd(loadedEntries);
                                
                                await loadData(); 
                                showMessage("Passwords restored successfully from Dashboard!", "success");
                            }
                        } catch (e) {
                            console.error("Error restoring IndexedDB data in password.html:", e);
                            showMessage("Restore failed: Invalid data format or decryption key.", "error");
                        }
                    }
                }
                window.parent.postMessage({
                    action: 'restoreComplete',
                    file: 'password.html'
                }, '*');
            }
        });
        // --- END COMMUNICATION SCRIPT ---

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENT SELECTION (Moved inside DOMContentLoaded) ---
            passwordList = document.getElementById('password-list');
            const addBtn = document.getElementById('add-btn');
            searchInput = document.getElementById('search-input');
            passwordModal = document.getElementById('password-modal');
            passwordForm = document.getElementById('password-form');
            const modalTitle = document.getElementById('modal-title');
            entryIdInput = document.getElementById('entry-id');
            siteIdInput = document.getElementById('site-id-input');
            customerNameInput = document.getElementById('customer-name-input');
            passwordFieldsContainer = document.getElementById('password-fields-container');
            const addFieldBtn = document.getElementById('add-field-btn');
            messageBox = document.getElementById('messageBox');
            
            const mainContent = document.getElementById('main-content');
            const mainHeader = document.getElementById('main-header');

            const backupBtn = document.getElementById('backup-btn');
            const restoreInput = document.getElementById('restore-input');
            const themeToggle = document.getElementById('theme-toggle');

            // --- Modal and Action Logic (Relies on scoped DOM elements) ---
            const openModal = (entry = null) => {
                passwordForm.reset();
                passwordFieldsContainer.innerHTML = '';
                entryIdInput.value = '';

                if (entry) {
                    modalTitle.textContent = 'Edit Password';
                    entryIdInput.value = entry.id;
                    siteIdInput.value = entry.siteId;
                    customerNameInput.value = entry.customerName;
                    
                    const allKeys = [...new Set([...defaultPasswordFields, ...Object.keys(entry.passwords)])];
                    allKeys.forEach(key => addPasswordField(key, entry.passwords[key] || ''));
                } else {
                    modalTitle.textContent = 'Add New Password';
                    defaultPasswordFields.forEach(field => addPasswordField(field));
                }
                passwordModal.classList.add('active');
            };
            
            const closeModal = (modal) => {
                modal.classList.remove('active');
            };

            const addPasswordField = (key = '', value = '') => {
                const fieldId = Date.now();
                const div = document.createElement('div');
                div.className = 'form-group password-field-group';
                div.innerHTML = `
                    <label for="password-${fieldId}">${key || 'New Field'}</label>
                    <input type="text" id="password-${fieldId}" data-key="${key}" value="${value}">
                `;
                passwordFieldsContainer.appendChild(div);
                if (!key) {
                    const newKey = prompt("Enter new password field name (e.g., 'other'):");
                    if (newKey) {
                        const input = div.querySelector('input');
                        input.dataset.key = newKey.toLowerCase().replace(/\s/g, '');
                        div.querySelector('label').textContent = newKey;
                    } else {
                        div.remove();
                    }
                }
            };
            
            // --- Event Listeners ---
            addBtn.addEventListener('click', () => { openModal(); });
            searchInput.addEventListener('input', () => { renderPasswords(); });
            addFieldBtn.addEventListener('click', () => { addPasswordField(); });

            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(passwordModal)));
            passwordModal.addEventListener('click', e => { if (e.target === passwordModal) closeModal(passwordModal); });
            
            passwordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const passwords = {};
                passwordFieldsContainer.querySelectorAll('input').forEach(input => {
                    if (input.dataset.key && input.value) {
                        passwords[input.dataset.key] = input.value;
                    }
                });

                const newEntry = {
                    id: entryIdInput.value || Date.now(),
                    siteId: siteIdInput.value,
                    customerName: customerNameInput.value,
                    passwords: passwords
                };

                if (entryIdInput.value) {
                    const index = passwordEntries.findIndex(e => e.id == newEntry.id);
                    if (index !== -1) {
                        passwordEntries[index] = newEntry;
                    }
                } else {
                    passwordEntries.push(newEntry);
                }
                
                await saveData();
                renderPasswords();
                closeModal(passwordModal);
            });

            passwordList.addEventListener('click', (e) => {
                const unhideBtn = e.target.closest('.unhide-btn');
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const passwordFieldCard = e.target.closest('.password-field-card');

                if (unhideBtn) {
                    const entryDiv = unhideBtn.closest('.password-entry');
                    const isHidden = entryDiv.querySelector('.password-hidden');
                    const icon = unhideBtn.querySelector('i');
                    entryDiv.querySelectorAll('.password-field-card').forEach(card => {
                        const passwordExists = card.dataset.password && card.dataset.password.length > 0;
                        if (passwordExists) {
                            card.classList.toggle('password-hidden', !isHidden);
                            card.textContent = isHidden ? card.dataset.password : '****';
                        }
                    });
                    icon.className = isHidden ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
                } else if (editBtn) {
                    const entryDiv = editBtn.closest('.password-entry');
                    const id = entryDiv.dataset.id;
                    const entryToEdit = passwordEntries.find(entry => entry.id == id);
                    if (entryToEdit) openModal(entryToEdit);
                } else if (deleteBtn) {
                    const entryDiv = deleteBtn.closest('.password-entry');
                    const id = entryDiv.dataset.id;
                    if (confirm("Are you sure you want to delete this password entry?")) {
                        passwordEntries = passwordEntries.filter(entry => entry.id != id);
                        saveData();
                        renderPasswords();
                        showMessage("Password entry deleted.", "success");
                    }
                } else if (passwordFieldCard && passwordFieldCard.dataset.password) {
                    navigator.clipboard.writeText(passwordFieldCard.dataset.password)
                        .then(() => showMessage("Password copied!", "success"))
                        .catch(() => showMessage("Failed to copy.", "error"));
                }
            });
            
            // --- Backup & Restore Functions ---
            backupBtn.addEventListener('click', async () => {
                try {
                    const allEntries = await db.entries.toArray();
                    const dataStr = JSON.stringify(allEntries, null, 2);
                    
                    const encryptedData = CryptoJS.AES.encrypt(dataStr, staticEncryptionKey).toString();

                    const blob = new Blob([encryptedData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `password-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage("Backup saved successfully!", "success");
                } catch(e) {
                    console.error("Backup failed:", e);
                    showMessage("Backup failed. Check console for details.", "error");
                }
            });

            restoreInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const encryptedContent = e.target.result;
                        const decryptedBytes = CryptoJS.AES.decrypt(encryptedContent, staticEncryptionKey);
                        const decryptedString = decryptedBytes.toString(CryptoJS.enc.Utf8);
                        
                        if (!decryptedString) throw new Error("Incorrect password or corrupted file.");

                        // The decrypted string contains the JSON string of the encrypted entries array
                        const loadedEntries = JSON.parse(decryptedString);
                        
                        if (!Array.isArray(loadedEntries)) throw new Error("Invalid file format.");

                        if (confirm("Restoring will overwrite all current passwords. Are you sure?")) {
                            // Note: Loaded entries are already encrypted {data: "..."} objects
                            await db.entries.clear();
                            await db.entries.bulkAdd(loadedEntries);
                            await loadData();
                            showMessage("Passwords restored successfully!", "success");
                        }
                    } catch (err) {
                        console.error("Restore failed:", err);
                        showMessage("Error restoring. Incorrect key or invalid file.", "error");
                    } finally {
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            });
            
            const toggleTheme = () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                themeToggle.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
                localStorage.setItem('passwordManagerTheme', isDark ? 'dark' : 'light');
            };
            themeToggle.addEventListener('click', toggleTheme);


            // --- Initialization ---
            // Moved loadData() call inside DOMContentLoaded to ensure elements are ready
            loadData();
            // NEW: Signal 'pageReady' to the parent now that setup is complete
            window.parent.postMessage({ action: 'pageReady', file: 'password.html' }, '*');
        });
    </script>
</body>
</html>
